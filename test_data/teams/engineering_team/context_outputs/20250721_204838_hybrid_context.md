先理解记忆的内容，再基于七步框架集合user_message生成具体的结构化提示词

---

### 20250121103005_E5F6
**Project:** workflow-management-system
**Importance:** ⭐⭐⭐⭐⭐
**Tags:** architecture, workflow, backend, api-design

# 工作流API设计原则与技术要点

## 关键设计原则

1. **分层架构**: Controller -> Service -> Repository -> DAO -> Database
2. **数据校验**: 多层级的参数验证和业务规则检查
3. **异常处理**: 统一的错误响应格式和异常传播
4. **性能优化**: 批量查询、分页支持、数据库索引优化
5. **安全考虑**: 用户上下文验证、权限检查、SQL注入防护
6. **数据一致性**: 事务管理、并发控制、乐观锁机制

## 技术实现要点

### API端点设计
- POST /api/v1/workflows - 创建工作流
- GET /api/v1/workflows - 分页查询工作流
- GET /api/v1/workflows/ids - 批量查询工作流
- POST /api/v1/workflows/check-updates - 检查更新

### 数据库设计考虑
- 工作流表结构优化
- 复合索引设计(name+owner, created_at等)
- 规则表关联设计
- 审计字段完整性

### 缓存策略
- 常用工作流缓存
- 规则内容缓存
- 用户权限缓存
- 查询结果缓存

### 监控和日志
- 操作审计日志
- 性能指标监控
- 异常告警机制
- 业务数据统计

---

### 20250121103001_A1B2
**Project:** workflow-management-system
**Importance:** ⭐⭐⭐⭐⭐
**Tags:** create-workflow, api-flow, business-logic, sequence-diagram

# 创建工作流时序图流程设计

## 完整创建工作流时序图

```
sequenceDiagram
    participant Client
    participant WorkflowController
    participant WorkflowService
    participant UserContext
    participant RuleRepository
    participant WorkflowRepository
    participant WorkflowDAO
    participant Database

    Client->>WorkflowController: POST /api/v1/workflows<br/>(WorkflowRequest)
    WorkflowController->>WorkflowService: createWorkflow(workflowRequest)
    
    WorkflowService->>UserContext: getCurrentUserEmail()
    UserContext-->>WorkflowService: userEmail
    WorkflowService->>WorkflowService: enrichWithUserEmail(request)
    
    WorkflowService->>RuleRepository: findAllByIdIn(orderedSteps)
    RuleRepository->>Database: SELECT rules WHERE id IN (...)
    Database-->>RuleRepository: List<Rule>
    RuleRepository-->>WorkflowService: existingRules
    WorkflowService->>WorkflowService: validateIfPromptExists()
    
    WorkflowService->>WorkflowRepository: findByNameAndOwner(name, owner)
    WorkflowRepository->>WorkflowDAO: findByNameAndOwner(name, owner)
    WorkflowDAO->>Database: SELECT workflow WHERE name=? AND owner=?
    Database-->>WorkflowDAO: Optional<WorkflowPO>
    WorkflowDAO-->>WorkflowRepository: Optional<WorkflowPO>
    WorkflowRepository-->>WorkflowService: Optional<Workflow>
    
    alt Workflow not exists
        WorkflowService->>WorkflowService: Workflow.fromRequest(request)
        WorkflowService->>WorkflowRepository: save(workflow)
        WorkflowRepository->>WorkflowDAO: save(workflowPO)
        WorkflowDAO->>Database: INSERT INTO workflows
        Database-->>WorkflowDAO: saved WorkflowPO
        WorkflowDAO-->>WorkflowRepository: saved WorkflowPO
        WorkflowRepository-->>WorkflowService: saved Workflow
    else Workflow exists
        WorkflowService-->>WorkflowService: return existing workflow
    end
    
    WorkflowService-->>WorkflowController: Workflow
    WorkflowController->>WorkflowController: WorkflowResponse.of(workflow)
    WorkflowController-->>Client: 201 CREATED<br/>WorkflowResponse
```

## 关键流程要点

1. **用户验证**: 通过UserContext获取当前用户邮箱
2. **请求丰富**: enrichWithUserEmail补充用户信息到请求中
3. **规则验证**: 批量查询orderedSteps中的规则，确保存在性
4. **重复检查**: 按name+owner查询，避免重复创建工作流
5. **条件处理**: 不存在则创建新工作流，存在则返回现有工作流
6. **数据转换**: 实体层面的转换确保数据一致性

---

### 20250121103004_D4E5
**Project:** workflow-management-system
**Importance:** ⭐⭐⭐⭐
**Tags:** performance-optimization, batch-query, scalability, api-design, sequence-diagram

# 批量查询工作流时序图流程设计

## 完整批量查询工作流时序图

```
sequenceDiagram
    participant Client
    participant WorkflowController
    participant WorkflowService
    participant WorkflowRepository
    participant WorkflowDAO
    participant Database

    Client->>WorkflowController: GET /api/v1/workflows/ids?ids=id1,id2,id3
    
    alt ids validation
        WorkflowController->>WorkflowController: validate ids not empty
        WorkflowController->>WorkflowController: validate ids.size() <= 100
    else validation fails
        WorkflowController-->>Client: 400 Bad Request<br/>"Parameter validation error"
    end
    
    WorkflowController->>WorkflowService: getWorkflowsByIds(ids)
    WorkflowService->>WorkflowRepository: findAllByIdIn(ids)
    WorkflowRepository->>WorkflowDAO: findAllById(ids)
    WorkflowDAO->>Database: SELECT workflows WHERE id IN (...)
    Database-->>WorkflowDAO: List<WorkflowPO>
    WorkflowDAO-->>WorkflowRepository: List<WorkflowPO>
    
    WorkflowRepository->>WorkflowRepository: convert List<WorkflowPO> to List<Workflow>
    WorkflowRepository-->>WorkflowService: List<Workflow>
    WorkflowService-->>WorkflowController: List<Workflow>
    
    WorkflowController->>WorkflowController: WorkflowResponse.of(workflows)
    WorkflowController-->>Client: 200 OK<br/>List<WorkflowResponse>
```

## 批量查询优化策略

1. **参数限制**: 最多支持100个ID，防止单次查询过载
2. **参数验证**: Controller层进行ids非空和数量检查
3. **批量查询**: 使用IN子句进行单次数据库查询，避免循环查询
4. **错误容忍**: ID不存在时静默忽略，返回存在的记录
5. **性能优化**: 主键索引保证O(log n)查询复杂度

---

### 20250721194007_751E
**Project:** workflow-management-system
**Importance:** ⭐⭐⭐⭐⭐
**Tags:** architecture, workflow, entity-design, data-model

# 工作流API业务模型关系设计

## 完整业务模型类图

```
classDiagram
    direction TB
    
    class Workflow {
        +String id
        +String name
        +String description
        +List~String~ orderedSteps
        +String owner
        +LocalDateTime createdAt
        +LocalDateTime updatedAt
        +fromRequest(WorkflowRequest) Workflow
        +fromPO(WorkflowPO) Workflow
        +hasSameSequence(List~String~) boolean
    }
    
    class WorkflowRequest {
        +String name
        +String description
        +List~String~ orderedSteps
        +String owner
    }
    
    class WorkflowResponse {
        +String id
        +String name
        +String description
        +List~String~ orderedSteps
        +String owner
        +LocalDateTime createdAt
        +LocalDateTime updatedAt
        +of(Workflow) WorkflowResponse
        +of(List~Workflow~) List~WorkflowResponse~
    }
    
    class WorkflowPO {
        +String id
        +String name
        +String description
        +List~String~ orderedSteps
        +String owner
        +LocalDateTime createdAt
        +LocalDateTime updatedAt
        +of(Workflow) WorkflowPO
    }
    
    class PagedWorkflowResponse {
        +List~WorkflowResponse~ content
        +int totalPages
        +long totalElements
        +int size
        +int number
        +boolean first
        +boolean last
        +of(Page~Workflow~) PagedWorkflowResponse
    }
    
    class WorkflowQueryParams {
        +String name
        +String description
        +String owner
        +Integer page
        +Integer pageSize
        +String sortBy
        +String sortOrder
    }
    
    class WorkflowUpdateCheckRequest {
        +String workflowId
        +List~RuleHashInfo~ rulesHashes
    }
    
    class RuleHashInfo {
        +String ruleId
        +String contentHash
    }
    
    class WorkflowUpdateCheckResponse {
        +String workflowId
        +boolean isOrderedStepsUpdated
        +List~String~ orderedSteps
        +boolean isRulesUpdated
        +List~String~ updatedRules
        +of(...) WorkflowUpdateCheckResponse
    }
    
    class Rule {
        +String id
        +String contentHash
    }
    
    WorkflowRequest --> Workflow : creates
    Workflow --> WorkflowResponse : maps to
    Workflow --> WorkflowPO : persists as
    WorkflowPO --> Workflow : converts to
    PagedWorkflowResponse --> WorkflowResponse : contains
    WorkflowQueryParams --> Workflow : queries
    WorkflowUpdateCheckRequest --> RuleHashInfo : contains
    WorkflowUpdateCheckRequest --> WorkflowUpdateCheckResponse : produces
    Workflow --> Rule : references via orderedSteps
```

## 实体关系说明

---

### 20250121103003_C3D4
**Project:** workflow-management-system
**Importance:** ⭐⭐⭐⭐
**Tags:** cache-invalidation, incremental, version-control, update-check, sequence-diagram

# 检查工作流更新时序图流程设计

## 完整检查工作流更新时序图

```
sequenceDiagram
    participant Client
    participant WorkflowController
    participant WorkflowService
    participant WorkflowRepository
    participant RuleRepository
    participant Database

    Client->>WorkflowController: POST /api/v1/workflows/check-updates<br/>(WorkflowUpdateCheckRequest)
    WorkflowController->>WorkflowService: checkWorkflowUpdates(request)
    
    WorkflowService->>WorkflowRepository: findWorkflowById(workflowId)
    WorkflowRepository->>Database: SELECT workflow WHERE id=?
    Database-->>WorkflowRepository: Optional<Workflow>
    WorkflowRepository-->>WorkflowService: Workflow
    
    WorkflowService->>WorkflowService: checkOrderedStepsUpdated(workflow, request)
    Note over WorkflowService: Compare request.rulesHashes.ruleIds<br/>with workflow.orderedSteps sequence
    
    alt rulesHashes not empty
        WorkflowService->>RuleRepository: findAllByIdIn(ruleIds)
        RuleRepository->>Database: SELECT rules WHERE id IN (...)
        Database-->>RuleRepository: List<Rule>
        RuleRepository-->>WorkflowService: currentRules
        
        WorkflowService->>WorkflowService: checkRulesUpdated(request)
        Note over WorkflowService: Compare contentHash and<br/>find non-existent rules
    else rulesHashes empty
        WorkflowService->>WorkflowService: return empty updatedRules
    end
    
    WorkflowService->>WorkflowService: WorkflowUpdateCheckResponse.of(...)
    WorkflowService-->>WorkflowController: WorkflowUpdateCheckResponse
    WorkflowController-->>Client: 200 OK<br/>WorkflowUpdateCheckResponse
```

## 更新检查机制

1. **步骤序列检查**: 比较客户端rulesHashes.ruleIds与服务端workflow.orderedSteps的序列差异
2. **规则内容检查**: 通过contentHash对比检测规则内容变更
3. **增量检测**: 只返回实际发生变更的规则ID列表
4. **性能优化**: 条件批量查询规则，避免N+1查询问题
5. **空值处理**: rulesHashes为空时直接返回空的更新列表

---

# 业务模型（Business Model）

## 目标
构建清晰的业务实体关系模型，为后续设计提供概念基础

## 输出格式
```
## Business Model
```mermaid
classDiagram
direction TB

class [CoreEntity] {
    +[AttributeType] [attributeName]
    +[AttributeType] [attributeName]
    +[Method]()
}

class [RelatedEntity] {
    +[AttributeType] [attributeName]
    +[Method]()
}

class [RequestDTO] {
    +[AttributeType] [attributeName]
    +[ValidationRule]
}

class [ResponseDTO] {
    +[AttributeType] [attributeName]
    +[StaticMethod]()
}

[CoreEntity] "[cardinality]" -- "[cardinality]" [RelatedEntity] : [relationshipDesc]
[RequestDTO] --> [CoreEntity] : creates
[CoreEntity] --> [ResponseDTO] : maps to
```

## 构建要点
- **实体识别**：识别核心业务实体、支撑实体、DTO对象
- **属性建模**：为每个实体定义关键属性，使用"类型+名称"格式
- **关系建模**：明确实体间的关系类型（1:1, 1:N, N:M）和业务语义
- **遵循现有代码实现模式**：如果当前业务建模支持，则遵循现有代码建模，否则根据业务需求进行建模
- **接口设计**：包含关键的方法和静态工厂方法
- **数据流向**：体现请求->处理->响应的完整数据流
- **一致性保障**：确保模型能被AI准确理解和实现
- **简洁 > 功能丰富**：避免过度工程化，保持系统可理解性

## 质量标准
- 关注当前任务流程
- 实体关系清晰准确
- 支持后续技术实现 

---

# 需求锚定（Requirements）

## 目标
从需求描述中提取核心问题本质和根本目标

## 输出格式
```
## Requirements
[使用简洁的动词短语描述需求的本质，避免功能特性列举]
```

## 构建要点
- **本质提炼**：抽象出解决什么根本问题、为谁创造什么价值
- **边界定义**：明确解决方案的适用范围和限制条件
- **价值聚焦**：突出业务价值和用户获益
- **使用动词短语**：如"Implement..."、"Create..."、"Design..."
- **避免特征堆砌**：不要列举具体功能，要抽象出需要解决的本质问题

## 质量标准
- 一句话能概括核心需求
- 体现业务价值而非技术实现
- 明确问题边界和约束 

---
