#!/usr/bin/env python3
"""
System Promptç”Ÿæˆå™¨

ä¸“é—¨ç”¨äºæ ¹æ®user_messageæ‰¾åˆ°åˆé€‚çš„è®°å¿†ï¼Œç„¶åç»“åˆä¸ƒæ­¥æ¡†æ¶ç”Ÿæˆsystem_prompt
ä¸claude_test_runner.pyå…¨é¢æµ‹è¯•è¿‡ç¨‹ä¸­çš„system_promptç”Ÿæˆè¿‡ç¨‹å®Œå…¨ä¿æŒä¸€è‡´

åŠŸèƒ½ç‰¹æ€§ï¼š
1. ğŸ” æ™ºèƒ½è®°å¿†é€‰æ‹©ï¼šæ ¹æ®ç”¨æˆ·æ¶ˆæ¯å†…å®¹æ™ºèƒ½åŒ¹é…ç›¸å…³è®°å¿†
2. ğŸ“‹ ä¸ƒæ­¥æ¡†æ¶é›†æˆï¼šç»“åˆå®Œæ•´çš„ä¸ƒé˜¶æ®µæ¡†æ¶æ¨¡æ¿
3. ğŸ¯ æ··åˆæ¨¡å¼ï¼šè®°å¿†+æ¡†æ¶çš„æœ€ä¼˜ç»„åˆ
4. ğŸ§  å¢å¼ºè¯„åˆ†ï¼šä½¿ç”¨å¢å¼ºè¯„åˆ†ç®—æ³•è¿›è¡Œæ™ºèƒ½è®°å¿†é€‰æ‹©
5. âš™ï¸  å‚æ•°åŒ–é…ç½®ï¼šæ”¯æŒçµæ´»çš„ç”Ÿæˆå‚æ•°é…ç½®
6. ğŸ’¾ ç»“æœè¾“å‡ºï¼šå¯é€‰æ‹©ä¿å­˜æˆ–ç›´æ¥è¿”å›ç”Ÿæˆçš„system_prompt

ä½¿ç”¨æ–¹æ³•ï¼š
1. åˆ›å»ºç”Ÿæˆå™¨å®ä¾‹
2. è°ƒç”¨generate_system_promptæ–¹æ³•
3. è·å–ç»“æœsystem_prompt
"""

import sys
import os
from datetime import datetime
from pathlib import Path
from typing import Dict, Any, Optional

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°è·¯å¾„
project_root = Path(__file__).parent.parent.parent
sys.path.insert(0, str(project_root))

from src.commands.team_context_command import TeamContextCommand


class SystemPromptGenerator:
    """System Promptç”Ÿæˆå™¨ç±»"""
    
    def __init__(self, team_data_root: str = "test_data"):
        """
        åˆå§‹åŒ–System Promptç”Ÿæˆå™¨
        
        Args:
            team_data_root: å›¢é˜Ÿæ•°æ®æ ¹ç›®å½•
        """
        self.team_data_root = team_data_root
        self.context_command = TeamContextCommand(root_path=team_data_root)
        
        # ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
        self.output_dir = project_root / "output" / "system_prompts"
        self.output_dir.mkdir(parents=True, exist_ok=True)
    
    def _save_system_prompt(self, system_prompt: str, team_name: str, mode: str, user_message: str = "") -> str:
        """
        ä¿å­˜system promptåˆ°output/system_promptsç›®å½•
        
        Args:
            system_prompt: è¦ä¿å­˜çš„system promptå†…å®¹
            team_name: å›¢é˜Ÿåç§°
            mode: ç”Ÿæˆæ¨¡å¼
            user_message: ç”¨æˆ·æ¶ˆæ¯ï¼ˆç”¨äºç”Ÿæˆæè¿°ï¼‰
        
        Returns:
            ä¿å­˜çš„æ–‡ä»¶è·¯å¾„
        """
        # ç”Ÿæˆæ—¶é—´æˆ³
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        
        # ç”Ÿæˆæ–‡ä»¶å
        filename = f"{timestamp}_{team_name}_{mode}_system_prompt.txt"
        file_path = self.output_dir / filename
        
        # å‡†å¤‡æ–‡ä»¶å†…å®¹
        content_lines = [
            "=" * 80,
            f"System Prompt Generated - {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}",
            "=" * 80,
            f"Team: {team_name}",
            f"Mode: {mode}",
            f"Generated by: SystemPromptGenerator",
            ""
        ]
        
        # å¦‚æœæœ‰ç”¨æˆ·æ¶ˆæ¯ï¼Œæ·»åŠ åˆ°æ–‡ä»¶å¤´
        if user_message.strip():
            content_lines.extend([
                "User Message Context:",
                "-" * 40,
                user_message,
                "",
                "Generated System Prompt:",
                "-" * 40,
                ""
            ])
        else:
            content_lines.extend([
                "Generated System Prompt:",
                "-" * 40,
                ""
            ])
        
        # å†™å…¥æ–‡ä»¶
        try:
            with open(file_path, 'w', encoding='utf-8') as f:
                f.write('\n'.join(content_lines))
                f.write(system_prompt)
                f.write('\n')
            
            return str(file_path)
        except Exception as e:
            raise Exception(f"ä¿å­˜system promptå¤±è´¥: {e}")
    
    def get_available_teams(self) -> list:
        """è·å–å¯ç”¨çš„å›¢é˜Ÿåˆ—è¡¨"""
        teams_path = Path(self.team_data_root) / "teams"
        if not teams_path.exists():
            return []
        
        return [d.name for d in teams_path.iterdir() if d.is_dir()]
    
    def generate_system_prompt(self, 
                             user_message: str,
                             team_name: str,
                             mode: str = "hybrid",
                             stages: Optional[str] = None,
                             memory_types: str = "all",
                             project_scope: Optional[str] = None,
                             memory_importance: int = 2,
                             max_memory_items: int = 50,
                             tags_filter: Optional[str] = None,
                             save_results: bool = False,
                             verbose: bool = True) -> Dict[str, Any]:
        """
        ç”Ÿæˆç³»ç»Ÿæç¤ºè¯
        
        Args:
            user_message: ç”¨æˆ·æ¶ˆæ¯ï¼Œç”¨äºæ™ºèƒ½é€‰æ‹©ç›¸å…³è®°å¿†
            team_name: å›¢é˜Ÿåç§°
            mode: ä¸Šä¸‹æ–‡æ¨¡å¼ (framework_only, memory_only, hybrid)
            stages: æ¡†æ¶é˜¶æ®µ (é€—å·åˆ†éš”æˆ–'all')
            memory_types: è®°å¿†ç±»å‹ ('declarative', 'procedural', 'episodic', 'all')
            project_scope: é¡¹ç›®èŒƒå›´è¿‡æ»¤å™¨
            memory_importance: è®°å¿†é‡è¦æ€§é˜ˆå€¼ (1-5)
            max_memory_items: æœ€å¤§è®°å¿†æ¡ç›®æ•°
            tags_filter: æ ‡ç­¾è¿‡æ»¤å™¨ (é€—å·åˆ†éš”)
            save_results: æ˜¯å¦ä¿å­˜ç»“æœåˆ°æ–‡ä»¶
            verbose: æ˜¯å¦æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
        
        Returns:
            åŒ…å«system_promptå’Œå…ƒæ•°æ®çš„ç»“æœå­—å…¸
        """
        try:
            if verbose:
                print(f"ğŸ¤– å¼€å§‹ç”ŸæˆSystem Prompt")
                print(f"ğŸ“‹ é…ç½®å‚æ•°:")
                print(f"   - å›¢é˜Ÿ: {team_name}")
                print(f"   - æ¨¡å¼: {mode}")
                print(f"   - ç”¨æˆ·æ¶ˆæ¯: {user_message[:100]}{'...' if len(user_message) > 100 else ''}")
                print(f"   - è®°å¿†é‡è¦æ€§: {memory_importance}")
                print(f"   - æœ€å¤§è®°å¿†æ•°: {max_memory_items}")
            
            # éªŒè¯å›¢é˜Ÿå­˜åœ¨
            available_teams = self.get_available_teams()
            if team_name not in available_teams:
                return {
                    "success": False,
                    "error": f"å›¢é˜Ÿ '{team_name}' ä¸å­˜åœ¨ã€‚å¯ç”¨å›¢é˜Ÿ: {available_teams}",
                    "available_teams": available_teams
                }
            
            # ä½¿ç”¨å›¢é˜Ÿä¸Šä¸‹æ–‡å‘½ä»¤ç”Ÿæˆä¸Šä¸‹æ–‡ - å®Œå…¨å¤åˆ¶claude_test_runner.pyçš„é€»è¾‘
            if verbose:
                print(f"ğŸ”„ è°ƒç”¨å›¢é˜Ÿä¸Šä¸‹æ–‡ç”Ÿæˆ...")
            
            result = self.context_command.execute(
                team_name=team_name,
                action="generate",
                mode=mode,
                stages=stages or "all",
                memory_types=memory_types,
                output_format="json",  # ä½¿ç”¨jsonæ ¼å¼ä»¥è·å–content
                save_results=save_results,
                project_scope=project_scope,
                memory_importance=memory_importance,
                max_memory_items=max_memory_items,
                tags_filter=tags_filter,
                user_message=user_message  # ä¼ é€’ç”¨æˆ·æ¶ˆæ¯ç”¨äºæ™ºèƒ½è®°å¿†é€‰æ‹©
            )
            
            if not result.success:
                return {
                    "success": False,
                    "error": f"ä¸Šä¸‹æ–‡ç”Ÿæˆå¤±è´¥: {result.error or result.message}",
                    "team_name": team_name,
                    "mode": mode
                }
            
            # ä»ç»“æœä¸­æå–system_promptå†…å®¹
            system_prompt = ""
            if hasattr(result, 'data') and result.data and 'content' in result.data:
                system_prompt = result.data['content']
            elif hasattr(result, 'content'):
                system_prompt = result.content
            else:
                system_prompt = result.message
            
            # å¦‚æœæ²¡æœ‰ç”Ÿæˆæœ‰æ•ˆå†…å®¹ï¼Œä½¿ç”¨é»˜è®¤æç¤ºè¯
            if not system_prompt or system_prompt.strip() == "":
                system_prompt = f"ä½ æ˜¯ä¸€ä¸ªä¸º{team_name}å›¢é˜Ÿå·¥ä½œçš„AIåŠ©æ‰‹ã€‚è¯·æ ¹æ®å›¢é˜Ÿç»éªŒå’Œæœ€ä½³å®è·µæä¾›æœ‰ç”¨ã€å‡†ç¡®çš„å“åº”ã€‚"
            
            # æ˜¾ç¤ºç”Ÿæˆç»“æœç»Ÿè®¡
            if verbose:
                print(f"âœ… System Promptç”ŸæˆæˆåŠŸ!")
                print(f"ğŸ“Š ç”Ÿæˆç»Ÿè®¡:")
                print(f"   - å†…å®¹é•¿åº¦: {len(system_prompt)}å­—ç¬¦")
                print(f"   - ç”Ÿæˆæ¨¡å¼: {mode}")
                
                # æ˜¾ç¤ºç”Ÿæˆçš„è®°å¿†ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
                if result.data and 'source_memories' in result.data:
                    memory_count = len(result.data['source_memories'])
                    print(f"   - ä½¿ç”¨è®°å¿†: {memory_count}ä¸ª")
                    if memory_count > 0:
                        print(f"   - è®°å¿†æ¥æº: {', '.join(result.data['source_memories'][:5])}{'...' if memory_count > 5 else ''}")
                
                # æ˜¾ç¤ºæ¡†æ¶é˜¶æ®µä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
                if result.data and 'framework_stages' in result.data:
                    stage_count = len(result.data['framework_stages'])
                    print(f"   - æ¡†æ¶é˜¶æ®µ: {stage_count}ä¸ª")
                    if stage_count > 0:
                        print(f"   - åŒ…å«é˜¶æ®µ: {', '.join(result.data['framework_stages'])}")
                
                # æ˜¾ç¤ºå†…å®¹é¢„è§ˆ
                print(f"\nğŸ“„ System Prompté¢„è§ˆ:")
                print("-" * 50)
                preview = system_prompt[:300] if system_prompt else ""
                print(f"{preview}{'...' if len(system_prompt) > 300 else ''}")
                print("-" * 50)
            
            # ä¿å­˜system promptåˆ°output/system_promptsç›®å½•
            try:
                saved_file_path = self._save_system_prompt(
                    system_prompt=system_prompt,
                    team_name=team_name,
                    mode=mode,
                    user_message=user_message
                )
                if verbose:
                    print(f"ğŸ’¾ System Promptå·²ä¿å­˜åˆ°: {saved_file_path}")
            except Exception as save_error:
                if verbose:
                    print(f"âš ï¸  ä¿å­˜å¤±è´¥: {save_error}")
                saved_file_path = None
            
            # æ„å»ºè¿”å›ç»“æœ
            generation_result = {
                "success": True,
                "system_prompt": system_prompt,
                "system_prompt_length": len(system_prompt),
                "team_name": team_name,
                "mode": mode,
                "user_message": user_message,
                "user_message_length": len(user_message),
                "generation_metadata": {
                    "stages": stages or "all",
                    "memory_types": memory_types,
                    "project_scope": project_scope,
                    "memory_importance": memory_importance,
                    "max_memory_items": max_memory_items,
                    "tags_filter": tags_filter
                },
                "saved_to": saved_file_path  # æ·»åŠ ä¿å­˜è·¯å¾„ä¿¡æ¯
            }
            
            # æ·»åŠ è¯¦ç»†çš„ç”Ÿæˆæ•°æ®ï¼ˆå¦‚æœæœ‰ï¼‰
            if result.data:
                generation_result["context_data"] = result.data
            
            # ä¿ç•™åŸæœ‰çš„ä¿å­˜ç»“æœä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
            if save_results and result.data and 'saved_to' in result.data:
                generation_result["context_saved_to"] = result.data['saved_to']
                if verbose:
                    print(f"ğŸ’¾ ä¸Šä¸‹æ–‡ç»“æœå·²ä¿å­˜åˆ°: {result.data['saved_to']}")
            
            return generation_result
            
        except Exception as e:
            if verbose:
                print(f"âŒ System Promptç”Ÿæˆå¤±è´¥: {e}")
                import traceback
                traceback.print_exc()
            return {
                "success": False,
                "error": str(e),
                "team_name": team_name,
                "mode": mode,
                "user_message": user_message
            }
    
    def get_generator_info(self) -> Dict[str, Any]:
        """è·å–ç”Ÿæˆå™¨ä¿¡æ¯"""
        available_teams = self.get_available_teams()
        
        return {
            "team_data_root": self.team_data_root,
            "available_teams": available_teams,
            "team_count": len(available_teams),
            "supported_modes": ["hybrid", "framework_only", "memory_only"],
            "supported_memory_types": ["declarative", "procedural", "episodic", "all"],
            "default_config": {
                "mode": "hybrid",
                "memory_importance": 2,
                "max_memory_items": 50,
                "memory_types": "all",
                "stages": "all"
            }
        }


def create_system_prompt_generator(team_data_root: str = "test_data") -> SystemPromptGenerator:
    """
    åˆ›å»ºSystem Promptç”Ÿæˆå™¨å®ä¾‹
    
    Args:
        team_data_root: å›¢é˜Ÿæ•°æ®æ ¹ç›®å½•
    
    Returns:
        SystemPromptGeneratorå®ä¾‹
    """
    return SystemPromptGenerator(team_data_root) 