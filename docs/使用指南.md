# 使用指南

## 🚀 快速开始

### 环境准备

#### 系统要求
- Python 3.10+
- Git
- 8GB+ 内存 (推荐)
- 网络连接 (用于AI API调用)

#### 安装步骤

1. **克隆项目**
```bash
git clone <repository-url>
cd software-development-context-management
```

2. **创建虚拟环境**
```bash
python -m venv .venv
source .venv/bin/activate  # Linux/Mac
# 或
.venv\Scripts\activate     # Windows
```

3. **安装依赖**
```bash
pip install -r requirements.txt
```

4. **配置环境变量**
```bash
# 创建 .env 文件
echo "ANTHROPIC_API_KEY=your_claude_api_key" > .env
echo "OPENAI_API_KEY=your_openai_api_key" >> .env
echo "DEFAULT_MODEL=claude-3-sonnet-20241022" >> .env
```

5. **验证安装**
```bash
python -c "from src.core.system_prompt_generator import SystemPromptGenerator; print('✅ 安装成功')"
```

## 📋 基本使用

### 1. 创建团队和项目

#### 使用Python API
```python
from src.core.directory_manager import DirectoryManager
from pathlib import Path

# 初始化目录管理器
dm = DirectoryManager(Path("test_data"))

# 创建团队
team_path = dm.create_team("my_team", "我的开发团队")
print(f"团队创建成功: {team_path}")

# 创建项目
project_path = dm.create_project("my_team", "my_project", "我的项目")
print(f"项目创建成功: {project_path}")

# 列出团队的所有项目
projects = dm.list_projects("my_team")
print(f"团队项目: {projects}")
```

#### 使用命令行工具
```bash
# 创建团队结构 (需要手动创建目录)
mkdir -p test_data/teams/my_team/{memory/{episodic},context,projects}
mkdir -p test_data/teams/my_team/projects/my_project/{memory/{episodic},context}
```

### 2. 添加团队记忆

#### 程序性记忆 (操作流程)
```python
from src.commands.team_memory_command import TeamMemoryCommand

tmc = TeamMemoryCommand()

# 添加程序性记忆
result = tmc.execute(
    team_name="my_team",
    action="save",
    content="API设计的标准流程: 1) 需求分析 2) 接口设计 3) 实现开发 4) 测试验证 5) 文档编写",
    tags="API,设计流程,最佳实践",
    project="my_project",
    memory_type="procedural",
    importance=4
)
print(result.message)
```

#### 声明性记忆 (概念知识)
```python
# 添加声明性记忆
result = tmc.execute(
    team_name="my_team", 
    action="save",
    content="微服务架构的核心原则: 服务自治、松耦合、高内聚、独立部署、技术栈无关",
    tags="微服务,架构设计,核心原则",
    project="my_project",
    memory_type="declarative",
    importance=5
)
```

#### 情景性记忆 (具体经验)
```python
# 添加情景性记忆
result = tmc.execute(
    team_name="my_team",
    action="save", 
    content="在用户认证项目中，我们采用JWT+Redis的方案解决了分布式会话问题，性能提升30%",
    tags="JWT,Redis,分布式会话,性能优化",
    project="my_project",
    memory_type="episodic",
    importance=4
)
```

### 3. 生成System Prompt

#### 基本使用
```python
from src.core.system_prompt_generator import SystemPromptGenerator

# 创建生成器
generator = SystemPromptGenerator("test_data")

# 生成System Prompt
result = generator.generate_system_prompt(
    user_message="如何设计一个可扩展的用户认证系统？",
    team_name="my_team",
    mode="hybrid",  # 混合模式
    memory_types="all",
    memory_importance=2,
    max_memory_items=20,
    verbose=True
)

if result["success"]:
    print(f"✅ 生成成功!")
    print(f"📄 System Prompt长度: {result['system_prompt_length']}字符")
    print(f"💾 保存位置: {result['saved_to']}")
    
    # 查看生成的内容
    print("\n📋 生成的System Prompt预览:")
    print(result["system_prompt"][:500] + "...")
else:
    print(f"❌ 生成失败: {result['error']}")
```

#### 高级配置
```python
# 项目特定的System Prompt生成
result = generator.generate_system_prompt(
    user_message="实现工作流管理系统的API设计",
    team_name="engineering_team",
    mode="hybrid",
    stages="requirements,business-model,solution,structure",  # 指定框架阶段
    memory_types="procedural,declarative",  # 指定记忆类型
    project_scope="workflow-management-system",  # 项目范围
    memory_importance=3,  # 重要性阈值
    max_memory_items=15,  # 最大记忆数量
    tags_filter="API,设计,架构",  # 标签过滤
    save_results=True,
    verbose=True
)
```

### 4. 使用命令行工具

#### 生成团队上下文
```bash
# 基本用法
python -m src.commands.team_context_command engineering_team generate \
    --mode hybrid \
    --stages all \
    --memory-types all \
    --save-results

# 项目特定上下文
python -m src.commands.team_context_command engineering_team generate \
    --project-name workflow-management-system \
    --mode hybrid \
    --stages requirements,business-model,solution \
    --memory-importance 3 \
    --max-memory-items 20
```

#### 管理团队记忆
```bash
# 查看记忆列表
python -m src.commands.team_memory_command engineering_team list \
    --memory-type procedural \
    --query "API设计" \
    --limit 10

# 添加新记忆
python -m src.commands.team_memory_command engineering_team save \
    --content "数据库设计的三范式原则: 1NF确保原子性，2NF消除部分依赖，3NF消除传递依赖" \
    --tags "数据库,设计原则,三范式" \
    --memory-type declarative \
    --importance 4

# 导出记忆
python -m src.commands.team_memory_command engineering_team export \
    --memory-type all \
    --format json \
    --output-file team_memories_backup.json
```

### 5. 使用脚本工具

#### 快速生成System Prompt
```bash
# 编辑用户消息文件
echo "如何实现一个高可用的微服务架构？" > user_message.txt

# 运行生成脚本
python generate_prompt_for_user_message.py

# 查看生成结果
ls output/system_prompts/
```

#### 批量处理
```python
# 批量生成多个查询的System Prompt
queries = [
    "如何设计RESTful API？",
    "实现分布式锁的最佳方案？", 
    "数据库索引优化策略？",
    "微服务间通信方式对比？"
]

generator = SystemPromptGenerator("test_data") 

for i, query in enumerate(queries, 1):
    print(f"\n处理查询 {i}/{len(queries)}: {query}")
    result = generator.generate_system_prompt(
        user_message=query,
        team_name="engineering_team",
        mode="hybrid",
        verbose=False
    )
    
    if result["success"]:
        print(f"✅ 生成成功: {result['saved_to']}")
    else:
        print(f"❌ 生成失败: {result['error']}")
```

## ⚙️ 高级配置

### 1. 生成模式配置

#### 记忆模式 (Memory Only)
```python
# 仅使用团队历史记忆生成
config = {
    "mode": "memory_only",
    "memory_types": "all",
    "max_memory_items": 30,
    "memory_importance_threshold": 2
}
```

#### 框架模式 (Framework Only)  
```python
# 仅使用七步开发框架
config = {
    "mode": "framework_only",
    "stages": "requirements,business-model,solution,structure,tasks",
    "include_team_context": True
}
```

#### 混合模式 (Hybrid) - 推荐
```python
# 结合记忆和框架的最优模式
config = {
    "mode": "hybrid",
    "memory_types": "procedural,declarative",
    "stages": "all", 
    "max_memory_items": 20,
    "memory_importance_threshold": 3,
    "include_team_memories": True
}
```

### 2. 记忆过滤配置

#### 项目范围过滤
```python
# 只使用特定项目的记忆
result = generator.generate_system_prompt(
    user_message="用户认证系统设计",
    team_name="engineering_team",
    project_scope="auth-system",  # 限制项目范围
    mode="hybrid"
)
```

#### 标签过滤
```python
# 只使用包含特定标签的记忆
result = generator.generate_system_prompt(
    user_message="API安全性设计",
    team_name="engineering_team", 
    tags_filter="API,安全,认证,授权",  # 标签过滤
    mode="memory_only"
)
```

#### 时间范围过滤
```python
# 只使用最近的记忆 (需要自定义实现)
from datetime import datetime, timedelta

recent_threshold = datetime.now() - timedelta(days=90)
config = create_hybrid_config(
    team_name="engineering_team",
    time_range=(recent_threshold.isoformat(), datetime.now().isoformat())
)
```

### 3. 评分引擎配置

#### 启用自学习评分引擎
```python
# 启用自学习和优化功能
generator = SystemPromptGenerator("test_data")
generator.enable_learning(True)

# 生成System Prompt
result = generator.generate_system_prompt(
    user_message="分布式系统设计原则",
    team_name="engineering_team",
    enable_learning=True  # 为本次生成启用学习
)

# 提供使用反馈
feedback_result = generator.provide_usage_feedback(
    team_name="engineering_team",
    user_message="分布式系统设计原则", 
    system_prompt_effectiveness=5,  # 1-5评分
    matched_memories=result.get("context_data", {}).get("source_memories", []),
    comment="生成的内容很有帮助，包含了关键的设计原则"
)
```

#### 评分引擎性能调优
```python
from src.core.context_processor import ContextProcessor

processor = ContextProcessor("test_data", enable_optimized_scoring=True)

# 查看性能统计
stats = processor.get_scoring_performance_stats()
print(f"缓存命中率: {stats.get('cache_hit_rate', 0):.2%}")
print(f"平均响应时间: {stats.get('avg_response_time', 0):.3f}s")

# 手动调整关键词权重
processor.update_keyword_weight("microservice", "architecture", 1.2, confidence=0.9)
processor.update_keyword_weight("distributed", "system", 1.1, confidence=0.8)

# 保存优化状态
processor.save_scoring_engine_state()
```

### 4. AI模型配置

#### 模型选择
```python
# 在环境变量中配置
# DEFAULT_MODEL=claude-3-sonnet-20241022  # Claude模型
# DEFAULT_MODEL=gpt-4  # OpenAI模型

# 或在代码中指定
from src.agent.claude.ai_model_factory import AIModelFactory

factory = AIModelFactory()
claude_model = factory.create_model("claude")
openai_model = factory.create_model("openai")
```

#### 模型参数调优
```python
# 通过环境变量配置
# MAX_TOKENS=4096
# TEMPERATURE=0.1  # 更确定性的输出
# TOP_P=0.9

# 或程序化配置
model_config = {
    "max_tokens": 4096,
    "temperature": 0.1,
    "top_p": 0.9,
    "stop_sequences": ["---", "END"]
}
```

## 📊 监控和优化

### 1. 生成质量监控

#### 查看生成统计
```python
# 生成System Prompt后查看详细统计
result = generator.generate_system_prompt(
    user_message="微服务架构设计",
    team_name="engineering_team",
    verbose=True
)

print("📊 生成统计:")
print(f"   - 内容长度: {result['system_prompt_length']}字符")
print(f"   - 使用记忆: {len(result.get('context_data', {}).get('source_memories', []))}个") 
print(f"   - 框架阶段: {len(result.get('context_data', {}).get('framework_stages', []))}个")
```

#### 分析记忆匹配效果
```python
# 查看匹配的记忆详情
context_data = result.get("context_data", {})
if "source_memories" in context_data:
    print("\n🧠 匹配的记忆:")
    for memory_id in context_data["source_memories"]:
        print(f"   - {memory_id}")

# 查看使用的框架阶段
if "framework_stages" in context_data:
    print("\n📋 使用的框架阶段:")
    for stage in context_data["framework_stages"]:
        print(f"   - {stage}")
```

### 2. 性能优化

#### 缓存优化
```python
# 启用缓存以提高性能
processor = ContextProcessor("test_data", enable_optimized_scoring=True)

# 预热缓存 (可选)
common_queries = [
    "API设计最佳实践",
    "数据库优化策略", 
    "微服务架构原则",
    "系统安全设计"
]

for query in common_queries:
    processor.generate_context(
        create_hybrid_config("engineering_team"),
        query
    )
```

#### 批量处理优化
```python
# 批量生成多个System Prompt
def batch_generate_prompts(queries, team_name, batch_size=5):
    generator = SystemPromptGenerator("test_data")
    results = []
    
    for i in range(0, len(queries), batch_size):
        batch = queries[i:i+batch_size]
        print(f"处理批次 {i//batch_size + 1}: {len(batch)} 个查询")
        
        batch_results = []
        for query in batch:
            result = generator.generate_system_prompt(
                user_message=query,
                team_name=team_name,
                verbose=False
            )
            batch_results.append(result)
        
        results.extend(batch_results)
        
        # 批次间短暂暂停，避免API限流
        import time
        time.sleep(1)
    
    return results
```

### 3. 学习效果分析

#### 查看学习统计
```python
# 查看团队的学习统计
generator = SystemPromptGenerator("test_data")
generator.enable_learning(True)

stats = generator.get_learning_statistics("engineering_team")
print("🎓 学习统计:")
print(f"   - 学习状态: {'启用' if stats.get('learning_enabled', False) else '禁用'}")
print(f"   - 总关键词数: {stats.get('total_keywords', 0)}")
print(f"   - 新发现关键词: {stats.get('discovered_keywords_count', 0)}")
print(f"   - 稳定关键词: {stats.get('stable_keywords_count', 0)}")
print(f"   - 生成会话: {stats.get('generation_sessions', {}).get('total_sessions', 0)}")
```

#### 学习报告生成
```python
from src.scoring_self_evolution.learning_visualization import LearningVisualization

# 生成学习报告 (如果有学习数据)
try:
    visualizer = LearningVisualization("test_data/teams/engineering_team/memory/keyword_matrix.json")
    report_path = visualizer.save_report("learning_report.md")
    print(f"📄 学习报告已生成: {report_path}")
except FileNotFoundError:
    print("⚠️ 未找到学习数据，需要先进行一些生成操作")
```

## 🔧 故障排除

### 常见问题解决

#### 1. API密钥问题
```python
# 检查API密钥配置
import os
from dotenv import load_dotenv

load_dotenv()

claude_key = os.getenv("ANTHROPIC_API_KEY")
openai_key = os.getenv("OPENAI_API_KEY")

print(f"Claude API Key: {'已配置' if claude_key else '未配置'}")
print(f"OpenAI API Key: {'已配置' if openai_key else '未配置'}")

if not claude_key and not openai_key:
    print("❌ 请配置至少一个API密钥")
```

#### 2. 团队数据不存在
```python
# 检查团队是否存在
from src.core.directory_manager import DirectoryManager

dm = DirectoryManager("test_data")
teams = dm.list_teams()

print(f"可用团队: {teams}")

if "my_team" not in teams:
    print("创建团队...")
    dm.create_team("my_team", "我的团队")
```

#### 3. 记忆文件格式问题
```python
# 验证记忆文件格式
from src.core.markdown_engine import MarkdownEngine

engine = MarkdownEngine()
try:
    memories = engine.load_memories("test_data/teams/my_team/memory/procedural.md")
    print(f"✅ 记忆文件格式正确，加载了 {len(memories)} 个记忆")
except Exception as e:
    print(f"❌ 记忆文件格式错误: {e}")
```

#### 4. 性能问题
```python
# 诊断性能问题
import time

start_time = time.time()

result = generator.generate_system_prompt(
    user_message="测试查询",
    team_name="engineering_team", 
    verbose=True
)

end_time = time.time()
processing_time = end_time - start_time

print(f"⏱️ 处理时间: {processing_time:.2f}秒")

if processing_time > 10:
    print("⚠️ 处理时间过长，建议:")
    print("   1. 启用缓存优化")
    print("   2. 减少最大记忆数量")
    print("   3. 提高重要性阈值")
```

### 调试模式

#### 启用详细日志
```python
import logging

# 配置详细日志
logging.basicConfig(
    level=logging.DEBUG,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)

# 生成System Prompt时会输出详细调试信息
result = generator.generate_system_prompt(
    user_message="调试测试",
    team_name="engineering_team",
    verbose=True
)
```

#### 调试评分算法
```python
from src.core.context_processor import ContextProcessor

processor = ContextProcessor("test_data")

# 启用评分调试
from src.core.context_processor import ENHANCED_SCORING_DEBUG
ENHANCED_SCORING_DEBUG = True

# 生成上下文查看详细评分过程
config = create_hybrid_config("engineering_team")
context = processor.generate_context(config, "API设计")
```

## 📚 最佳实践

### 1. 记忆管理最佳实践

#### 记忆分类原则
- **声明性记忆**: 存储概念、原理、定义等"是什么"的知识
- **程序性记忆**: 存储流程、方法、步骤等"怎么做"的知识
- **情景性记忆**: 存储具体项目经验、案例等"何时何地发生"的知识

#### 标签规范
```python
# 推荐的标签命名规范
good_tags = [
    "API-设计",      # 使用连字符分隔
    "数据库-优化",    # 中文标签清晰明确
    "微服务-架构",    # 技术栈相关
    "性能-调优",      # 功能分类
    "最佳实践"       # 通用分类
]

# 避免的标签
bad_tags = [
    "好的",          # 太通用
    "重要",          # 无具体含义
    "temp",         # 临时标签
    "test123"       # 测试标签未清理
]
```

### 2. System Prompt生成最佳实践

#### 查询消息编写技巧
```python
# 好的查询消息示例
good_queries = [
    "如何设计一个支持高并发的用户认证系统？",        # 具体技术问题
    "实现分布式锁时需要考虑哪些关键因素？",          # 明确的技术点
    "数据库分表分库的最佳实践和注意事项？",          # 具体实践指导
    "微服务间异步通信的可靠性如何保证？"            # 技术挑战解决
]

# 避免的查询消息
bad_queries = [
    "写代码",        # 太泛化
    "帮我做项目",     # 无具体需求
    "什么是API",     # 过于基础
    "请优化性能"      # 缺乏上下文
]
```

#### 模式选择指南
```python
# 根据需求选择合适的模式
def choose_mode(query_type):
    if query_type == "探索性问题":
        return "framework_only"  # 结构化思维引导
    elif query_type == "具体实现问题":  
        return "memory_only"     # 基于历史经验
    else:
        return "hybrid"          # 综合模式，推荐
```

### 3. 团队协作最佳实践

#### 知识维护流程
1. **定期评审**: 每月评审和更新过时的记忆
2. **质量控制**: 建立记忆质量评审机制
3. **标准统一**: 制定团队统一的记忆编写标准
4. **知识分享**: 定期分享新增的重要记忆

#### 版本管理
```bash
# 将记忆文件纳入版本管理
git add test_data/teams/*/memory/*.md
git commit -m "更新团队记忆: 添加API设计最佳实践"

# 定期备份重要数据
tar -czf team_memories_$(date +%Y%m%d).tar.gz test_data/teams/
```

这个使用指南提供了从基础安装到高级优化的完整使用流程，帮助用户快速上手并充分利用系统的各项功能。